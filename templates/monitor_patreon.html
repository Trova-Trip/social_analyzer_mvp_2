{% extends "base.html" %}
{% set active_page = platform %}

{% block title %}{{ platform_label }} Monitor{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold" style="color:#005c69;">{{ platform_icon }} {{ platform_label }} Monitor</h1>
        <p class="text-sm mt-0.5" style="color:#3c4858;opacity:0.7;">Pipeline stage tracker for discovery jobs</p>
    </div>
</div>

<!-- Active job panel -->
<div class="card p-6 mb-6" id="active-job-panel">
    <div class="flex items-center gap-3 mb-5">
        <div class="w-2 h-2 rounded-full pulse-ring" style="background:#00b2c9;" id="active-dot"></div>
        <h2 class="text-sm font-bold uppercase tracking-wide" style="color:#005c69;">Active Job</h2>
        <span class="ml-auto text-xs font-medium px-2 py-0.5 rounded-full" style="background:#e0f7fa;color:#005c69;" id="active-status-badge">â€”</span>
    </div>

    <div id="no-active-job" class="text-center py-8" style="color:#3c4858;opacity:0.4;">
        <div class="text-4xl mb-2">ðŸ’¤</div>
        <div class="text-sm">No active job</div>
    </div>

    <div id="active-job-content" class="hidden">
        <!-- Job meta -->
        <div class="flex flex-wrap gap-4 mb-6 text-xs" style="color:#3c4858;opacity:0.6;" id="active-meta"></div>

        <!-- Pipeline stage timeline -->
        <div id="pipeline-timeline" class="space-y-0"></div>
    </div>
</div>

<!-- Recent jobs table -->
<div class="card p-5">
    <h2 class="text-sm font-bold uppercase tracking-wide mb-4" style="color:#005c69;">Recent Jobs</h2>
    <div id="jobs-table">
        <div class="text-center py-6 text-sm" style="color:#3c4858;opacity:0.4;">Loading...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const PLATFORM = '{{ platform }}';

const STAGES = [
    { key: 'discovery',        icon: 'ðŸ”', label: 'Discovery',               sub: 'Keyword / query search' },
    { key: 'filtering',        icon: 'ðŸ§¹', label: 'Filtering',               sub: 'NSFW + attribute filters' },
    { key: 'enriching_core',   icon: 'ðŸ”—', label: 'Enrichment: Core',        sub: 'Google Bridge Â· RSS Â· Link Agg Pass 1' },
    { key: 'enriching_social', icon: 'ðŸ“±', label: 'Enrichment: Social Bios', sub: 'YouTube Â· Instagram Â· Twitter' },
    { key: 'link_agg_p2',      icon: 'ðŸ”„', label: 'Link Aggregation Pass 2', sub: 'New aggregator URLs from bios' },
    { key: 'contact_search',   icon: 'ðŸŒ', label: 'Contact Search',          sub: 'Google last-resort lookup' },
    { key: 'website_crawl',    icon: 'ðŸ•·ï¸', label: 'Website Crawl',           sub: '26 subpages + email extraction' },
    { key: 'apollo',           icon: 'ðŸ”­', label: 'Apollo.io',               sub: 'Person match for emails' },
    { key: 'leads_finder',     icon: 'ðŸŽ¯', label: 'Leads Finder',            sub: 'Domain-based email lookup' },
    { key: 'email_validation', icon: 'âœ…', label: 'Email Validation',        sub: 'MillionVerifier batch check' },
    { key: 'hubspot_import',   icon: 'ðŸ“¤', label: 'HubSpot Import',          sub: 'Batch contact creation' },
];

function statusColor(s) {
    if (s === 'completed') return '#10b981';
    if (s === 'running')   return '#00b2c9';
    if (s === 'failed')    return '#f65c4e';
    if (s === 'skipped')   return '#94a3b8';
    return '#d1d5db'; // pending
}
function statusBg(s) {
    if (s === 'completed') return '#d1fae5';
    if (s === 'running')   return '#e0f7fa';
    if (s === 'failed')    return '#fee2e2';
    if (s === 'skipped')   return '#f1f5f9';
    return '#f9fafb';
}
function statusLabel(s) {
    const map = { completed:'Done', running:'Runningâ€¦', failed:'Failed', skipped:'Skipped', pending:'Pending' };
    return map[s] || 'Pending';
}

function metricBadges(stageData) {
    const skip = new Set(['status','started_at','completed_at','duration_s']);
    return Object.entries(stageData)
        .filter(([k]) => !skip.has(k))
        .map(([k, v]) => {
            const label = k.replace(/_/g,' ');
            return `<span class="px-2 py-0.5 rounded text-xs" style="background:#f1f5f9;color:#3c4858;">${label}: <strong>${v}</strong></span>`;
        }).join(' ');
}

function renderPipeline(stages) {
    const container = document.getElementById('pipeline-timeline');
    container.innerHTML = '';

    STAGES.forEach((def, idx) => {
        const stageData = stages?.[def.key] || {};
        const status = stageData.status || 'pending';
        const color  = statusColor(status);
        const isLast = idx === STAGES.length - 1;

        const duration = stageData.duration_s
            ? (stageData.duration_s >= 60
                ? `${Math.round(stageData.duration_s/60)}m ${Math.round(stageData.duration_s%60)}s`
                : `${stageData.duration_s}s`)
            : '';

        const badges = (status === 'completed' || status === 'skipped') ? metricBadges(stageData) : '';
        const pulseClass = status === 'running' ? 'pulse-ring' : '';

        const row = document.createElement('div');
        row.className = 'flex gap-4';
        row.innerHTML = `
            <div class="flex flex-col items-center" style="width:40px;flex-shrink:0;">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm ${pulseClass} transition-all"
                     style="background:${statusBg(status)};border:2px solid ${color};">
                    ${status === 'completed' ? 'âœ“' : status === 'failed' ? 'âœ•' : status === 'skipped' ? 'â€“' : def.icon}
                </div>
                ${!isLast ? `<div class="flex-1 w-0.5 my-1" style="background:${status==='completed'?'#10b981':'#e5e7eb'};min-height:24px;"></div>` : ''}
            </div>
            <div class="flex-1 pb-4">
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="font-semibold text-sm" style="color:#005c69;">${def.label}</span>
                    <span class="text-xs px-2 py-0.5 rounded-full font-medium" style="background:${statusBg(status)};color:${color};">${statusLabel(status)}</span>
                    ${duration ? `<span class="text-xs" style="color:#3c4858;opacity:0.5;">${duration}</span>` : ''}
                </div>
                <div class="text-xs mt-0.5" style="color:#3c4858;opacity:0.5;">${def.sub}</div>
                ${badges ? `<div class="flex flex-wrap gap-1 mt-1.5">${badges}</div>` : ''}
                ${stageData.error ? `<div class="mt-1 text-xs" style="color:#f65c4e;">âš  ${stageData.error}</div>` : ''}
            </div>`;
        container.appendChild(row);
    });
}

function renderJobRow(job) {
    const started = job.started_at ? new Date(job.started_at).toLocaleString() : 'â€”';
    const statusColor = {'completed':'#10b981','failed':'#f65c4e','queued':'#94a3b8'}[job.status] || '#00b2c9';
    const statusBg2   = {'completed':'#d1fae5','failed':'#fee2e2','queued':'#f1f5f9'}[job.status] || '#e0f7fa';
    return `<tr class="border-t" style="border-color:#f3f4f6;">
        <td class="py-2 pr-4 text-xs font-mono" style="color:#3c4858;opacity:0.5;">${job.job_id?.slice(0,8)}â€¦</td>
        <td class="py-2 pr-4 text-xs" style="color:#3c4858;">${started}</td>
        <td class="py-2 pr-4 text-xs" style="color:#3c4858;">${job.profiles_found ?? 'â€”'}</td>
        <td class="py-2 pr-4 text-xs" style="color:#3c4858;">${job.new_contacts_created ?? 'â€”'}</td>
        <td class="py-2 pr-4 text-xs" style="color:#3c4858;">${job.duplicates_skipped ?? 'â€”'}</td>
        <td class="py-2 text-xs"><span class="px-2 py-0.5 rounded-full font-medium" style="background:${statusBg2};color:${statusColor};">${job.status}</span></td>
    </tr>`;
}

let activeJobId = null;

async function refresh() {
    try {
        const r   = await fetch(`/api/monitor/jobs/${PLATFORM}`);
        const jobs = await r.json();

        if (!jobs.length) {
            document.getElementById('no-active-job').classList.remove('hidden');
            document.getElementById('active-job-content').classList.add('hidden');
            document.getElementById('active-status-badge').textContent = 'No jobs';
            document.getElementById('jobs-table').innerHTML =
                '<div class="text-center py-6 text-sm" style="color:#3c4858;opacity:0.4;">No jobs yet</div>';
            return;
        }

        // Show active/latest job
        const latest = jobs[0];
        const isActive = !['completed','failed'].includes(latest.status);

        document.getElementById('active-dot').style.background = isActive ? '#00b2c9' : '#10b981';
        document.getElementById('active-status-badge').textContent = latest.status;

        document.getElementById('no-active-job').classList.add('hidden');
        document.getElementById('active-job-content').classList.remove('hidden');

        // Meta
        const started = latest.started_at ? new Date(latest.started_at).toLocaleString() : 'â€”';
        document.getElementById('active-meta').innerHTML =
            `<span>Job: <strong>${latest.job_id?.slice(0,12)}â€¦</strong></span>
             <span>Started: <strong>${started}</strong></span>
             <span>Profiles found: <strong>${latest.profiles_found ?? 'â€”'}</strong></span>
             ${latest.new_contacts_created != null ? `<span>Imported: <strong>${latest.new_contacts_created}</strong></span>` : ''}
             ${latest.duplicates_skipped != null ? `<span>Duplicates: <strong>${latest.duplicates_skipped}</strong></span>` : ''}`;

        renderPipeline(latest.stages || {});

        // Recent jobs table
        const thead = `<table class="w-full text-left">
            <thead><tr class="text-xs uppercase tracking-wide" style="color:#3c4858;opacity:0.5;">
                <th class="pb-2 pr-4">Job ID</th><th class="pb-2 pr-4">Started</th>
                <th class="pb-2 pr-4">Found</th><th class="pb-2 pr-4">Created</th>
                <th class="pb-2 pr-4">Dupes</th><th class="pb-2">Status</th>
            </tr></thead><tbody>`;
        const rows = jobs.map(renderJobRow).join('');
        document.getElementById('jobs-table').innerHTML = thead + rows + '</tbody></table>';

    } catch(e) { console.error('Monitor refresh failed', e); }
}

refresh();
setInterval(refresh, 8000);
</script>
{% endblock %}
