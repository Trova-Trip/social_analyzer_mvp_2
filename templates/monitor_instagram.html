{% extends "base.html" %}
{% set active_page = "instagram" %}

{% block title %}Instagram Monitor{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold" style="color:#005c69;">üì∏ Instagram Batch Monitor</h1>
        <p class="text-sm mt-0.5" style="color:#3c4858;opacity:0.7;">Real-time scoring queue &amp; tier distribution</p>
    </div>
    <button onclick="confirmReset()"
            class="flex items-center gap-2 text-sm font-medium px-4 py-2 rounded-lg border-2 transition-all hover:text-white"
            style="border-color:#f65c4e;color:#f65c4e;"
            onmouseover="this.style.background='#f65c4e'"
            onmouseout="this.style.background='transparent'">
        ‚Ü∫ Reset Stats
    </button>
</div>

<!-- KPI bar -->
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6" id="kpi-bar">
    <div class="card p-4">
        <div class="text-xs font-semibold uppercase tracking-wide mb-1" style="color:#00b2c9;">Queue</div>
        <div class="text-3xl font-bold" style="color:#005c69;" id="kpi-queue">‚Äî</div>
        <div class="text-xs mt-1" style="color:#3c4858;opacity:0.6;">profiles waiting</div>
    </div>
    <div class="card p-4">
        <div class="text-xs font-semibold uppercase tracking-wide mb-1" style="color:#00b2c9;">Processed</div>
        <div class="text-3xl font-bold" style="color:#005c69;" id="kpi-processed">‚Äî</div>
        <div class="text-xs mt-1" style="color:#3c4858;opacity:0.6;">this batch</div>
    </div>
    <div class="card p-4">
        <div class="text-xs font-semibold uppercase tracking-wide mb-1" style="color:#00b2c9;">Avg Time</div>
        <div class="text-3xl font-bold" style="color:#005c69;" id="kpi-avg">‚Äî</div>
        <div class="text-xs mt-1" style="color:#3c4858;opacity:0.6;">seconds / profile</div>
    </div>
    <div class="card p-4">
        <div class="text-xs font-semibold uppercase tracking-wide mb-1" style="color:#00b2c9;">ETA</div>
        <div class="text-3xl font-bold" style="color:#005c69;" id="kpi-eta">‚Äî</div>
        <div class="text-xs mt-1" style="color:#3c4858;opacity:0.6;">minutes remaining</div>
    </div>
</div>

<!-- Pipeline stages (horizontal) -->
<div class="card p-6 mb-6">
    <h2 class="text-sm font-bold uppercase tracking-wide mb-5" style="color:#005c69;">Scoring Pipeline</h2>
    <div class="flex items-start gap-0">

        <!-- Stage 1: Pre-screen -->
        <div class="flex-1 text-center px-2">
            <div class="w-10 h-10 rounded-full mx-auto flex items-center justify-center text-lg font-bold mb-2"
                 style="background:#e0f7fa;color:#005c69;">üîé</div>
            <div class="text-xs font-semibold" style="color:#005c69;">Pre-screen</div>
            <div class="text-xs mt-1" style="color:#3c4858;opacity:0.6;">Post freq + ICP</div>
            <div class="mt-2 text-lg font-bold" style="color:#3c4858;" id="ps-filtered">‚Äî</div>
            <div class="text-xs" style="color:#3c4858;opacity:0.5;">filtered</div>
        </div>
        <div class="flex items-center pt-5"><div class="w-8 h-0.5" style="background:#00b2c9;"></div></div>

        <!-- Stage 2: AI Scoring -->
        <div class="flex-1 text-center px-2">
            <div class="w-10 h-10 rounded-full mx-auto flex items-center justify-center text-lg font-bold mb-2"
                 style="background:#e0f7fa;color:#005c69;">ü§ñ</div>
            <div class="text-xs font-semibold" style="color:#005c69;">AI Scoring</div>
            <div class="text-xs mt-1" style="color:#3c4858;opacity:0.6;">5-dimension score</div>
            <div class="mt-2 text-lg font-bold" style="color:#3c4858;" id="ps-scored">‚Äî</div>
            <div class="text-xs" style="color:#3c4858;opacity:0.5;">scored</div>
        </div>
        <div class="flex items-center pt-5"><div class="w-8 h-0.5" style="background:#00b2c9;"></div></div>

        <!-- Stage 3: Tier Assignment -->
        <div class="flex-1 text-center px-2">
            <div class="w-10 h-10 rounded-full mx-auto flex items-center justify-center text-lg font-bold mb-2"
                 style="background:#e0f7fa;color:#005c69;">üè∑Ô∏è</div>
            <div class="text-xs font-semibold" style="color:#005c69;">Tier Assign</div>
            <div class="text-xs mt-1" style="color:#3c4858;opacity:0.6;">auto-enroll / review</div>
            <div class="mt-2 text-lg font-bold" style="color:#3c4858;" id="ps-tiered">‚Äî</div>
            <div class="text-xs" style="color:#3c4858;opacity:0.5;">tiered</div>
        </div>
        <div class="flex items-center pt-5"><div class="w-8 h-0.5" style="background:#00b2c9;"></div></div>

        <!-- Stage 4: HubSpot -->
        <div class="flex-1 text-center px-2">
            <div class="w-10 h-10 rounded-full mx-auto flex items-center justify-center text-lg font-bold mb-2"
                 style="background:#e0f7fa;color:#005c69;">üì§</div>
            <div class="text-xs font-semibold" style="color:#005c69;">HubSpot</div>
            <div class="text-xs mt-1" style="color:#3c4858;opacity:0.6;">contact import</div>
            <div class="mt-2 text-lg font-bold" style="color:#3c4858;" id="ps-imported">‚Äî</div>
            <div class="text-xs" style="color:#3c4858;opacity:0.5;">imported</div>
        </div>

    </div>
</div>

<!-- Two-col: Pre-screen breakdown + Tier distribution -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-6">

    <!-- Pre-screen breakdown -->
    <div class="card p-5">
        <h2 class="text-sm font-bold uppercase tracking-wide mb-4" style="color:#005c69;">Filter Breakdown</h2>
        <div class="space-y-3">
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <span style="color:#3c4858;">Low Post Frequency</span>
                    <span class="font-semibold" id="fb-lowfreq" style="color:#3c4858;">0</span>
                </div>
                <div class="h-2 rounded-full" style="background:#eeece1;">
                    <div id="fb-lowfreq-bar" class="h-2 rounded-full transition-all" style="background:#f65c4e;width:0%"></div>
                </div>
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <span style="color:#3c4858;">Outside ICP</span>
                    <span class="font-semibold" id="fb-icp" style="color:#3c4858;">0</span>
                </div>
                <div class="h-2 rounded-full" style="background:#eeece1;">
                    <div id="fb-icp-bar" class="h-2 rounded-full transition-all" style="background:#f65c4e;width:0%"></div>
                </div>
            </div>
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <span style="color:#3c4858;">Errors</span>
                    <span class="font-semibold" id="fb-errors" style="color:#3c4858;">0</span>
                </div>
                <div class="h-2 rounded-full" style="background:#eeece1;">
                    <div id="fb-errors-bar" class="h-2 rounded-full transition-all" style="background:#f65c4e;width:0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tier distribution -->
    <div class="card p-5">
        <h2 class="text-sm font-bold uppercase tracking-wide mb-4" style="color:#005c69;">Tier Distribution</h2>
        <div class="space-y-3">
            <!-- Auto-Enroll -->
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full inline-block" style="background:#10b981;"></span> Auto-Enroll</span>
                    <span class="font-semibold" id="t-auto" style="color:#3c4858;">0</span>
                </div>
                <div class="h-2.5 rounded-full" style="background:#eeece1;">
                    <div id="t-auto-bar" class="h-2.5 rounded-full transition-all" style="background:#10b981;width:0%"></div>
                </div>
            </div>
            <!-- Standard Review -->
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full inline-block" style="background:#00b2c9;"></span> Standard Review</span>
                    <span class="font-semibold" id="t-standard" style="color:#3c4858;">0</span>
                </div>
                <div class="h-2.5 rounded-full" style="background:#eeece1;">
                    <div id="t-standard-bar" class="h-2.5 rounded-full transition-all" style="background:#00b2c9;width:0%"></div>
                </div>
            </div>
            <!-- Low Priority -->
            <div>
                <div class="flex justify-between text-xs mb-1">
                    <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full inline-block" style="background:#94a3b8;"></span> Low Priority</span>
                    <span class="font-semibold" id="t-low" style="color:#3c4858;">0</span>
                </div>
                <div class="h-2.5 rounded-full" style="background:#eeece1;">
                    <div id="t-low-bar" class="h-2.5 rounded-full transition-all" style="background:#94a3b8;width:0%"></div>
                </div>
            </div>
        </div>
        <div class="mt-4 pt-3 border-t border-gray-100 flex justify-between text-xs" style="color:#3c4858;opacity:0.6;">
            <span>Pass rate</span>
            <span class="font-semibold" id="t-passrate">‚Äî%</span>
        </div>
    </div>

</div>

<!-- Reset confirmation modal -->
<div id="reset-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background:rgba(0,0,0,0.4);">
    <div class="card p-6 max-w-sm mx-4 w-full">
        <h3 class="font-bold text-lg mb-2" style="color:#005c69;">Reset Batch Stats?</h3>
        <p class="text-sm mb-5" style="color:#3c4858;opacity:0.7;">This will clear all current queue counters and tier distributions. This cannot be undone.</p>
        <div class="flex gap-3">
            <button onclick="doReset()" class="flex-1 py-2 rounded-lg text-white font-semibold text-sm" style="background:#f65c4e;">Reset</button>
            <button onclick="closeModal()" class="flex-1 py-2 rounded-lg font-semibold text-sm border" style="border-color:#d1d5db;color:#3c4858;">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmReset() {
    const m = document.getElementById('reset-modal');
    m.classList.remove('hidden');
    m.classList.add('flex');
}
function closeModal() {
    const m = document.getElementById('reset-modal');
    m.classList.add('hidden');
    m.classList.remove('flex');
}
async function doReset() {
    closeModal();
    try {
        await fetch('/api/stats/reset', { method: 'POST' });
        fetchStats();
    } catch(e) { alert('Reset failed: ' + e.message); }
}

function pct(a, total) { return total > 0 ? Math.round(a / total * 100) : 0; }
function bar(id, pct_val, color) {
    const el = document.getElementById(id);
    if (el) el.style.width = pct_val + '%';
}

async function fetchStats() {
    try {
        const r = await fetch('/api/stats');
        const d = await r.json();

        // KPIs
        document.getElementById('kpi-queue').textContent     = d.queue_size ?? '‚Äî';
        document.getElementById('kpi-processed').textContent = d.total_completed ?? '‚Äî';
        document.getElementById('kpi-avg').textContent       = d.avg_duration ?? '‚Äî';
        document.getElementById('kpi-eta').textContent       = d.est_time_remaining > 0 ? Math.round(d.est_time_remaining) : '‚Äî';

        // Pipeline stage counts
        const b = d.breakdown || {};
        const filtered = (b.post_frequency || 0) + (b.pre_screened || 0);
        const scored   = d.total_completed || 0;
        const tiered   = (d.priority_tiers?.total) || 0;
        document.getElementById('ps-filtered').textContent = filtered;
        document.getElementById('ps-scored').textContent   = scored;
        document.getElementById('ps-tiered').textContent   = tiered;
        document.getElementById('ps-imported').textContent = tiered;

        // Filter breakdown bars
        const totalProcessed = d.total_completed + d.total_errors || 1;
        document.getElementById('fb-lowfreq').textContent = b.post_frequency || 0;
        document.getElementById('fb-icp').textContent     = b.pre_screened || 0;
        document.getElementById('fb-errors').textContent  = d.total_errors || 0;
        bar('fb-lowfreq-bar', pct(b.post_frequency||0, totalProcessed));
        bar('fb-icp-bar',     pct(b.pre_screened||0,   totalProcessed));
        bar('fb-errors-bar',  pct(d.total_errors||0,   totalProcessed));

        // Tier distribution
        const tiers  = d.priority_tiers || {};
        const total  = tiers.total || 1;
        document.getElementById('t-auto').textContent     = tiers.auto_enroll || 0;
        document.getElementById('t-standard').textContent = tiers.standard_priority_review || 0;
        document.getElementById('t-low').textContent      = tiers.low_priority_review || 0;
        bar('t-auto-bar',     pct(tiers.auto_enroll||0,               total));
        bar('t-standard-bar', pct(tiers.standard_priority_review||0,  total));
        bar('t-low-bar',      pct(tiers.low_priority_review||0,       total));
        document.getElementById('t-passrate').textContent = (d.batch_quality?.pass_rate ?? '‚Äî') + '%';

    } catch(e) { console.error('Stats fetch failed', e); }
}

fetchStats();
setInterval(fetchStats, 5000);
</script>
{% endblock %}
